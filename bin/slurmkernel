#!/usr/bin/env python3

"""
slurmkernel
"""

import argparse;
import json;
import sys;
import os;
import getpass;
import re;
import tempfile;
import subprocess;
import slurm_jupyter_kernel;
from pathlib import Path;
from shutil import copy
try:
    from jupyter_client import kernelspec;
except ImportError:
    from IPython.kernel import kernelspec;

def add_slurm_kernel (displayname, language, kernelcmd, slurm_parameter, loginnode, proxyjump, srun_cmd, environment):
   
    print(f"\n\033[94m\u2687\033[0m Try to create slurm kernel '{displayname}'... \033[0m");
    args = [str(sys.executable), '-m', 'slurm_jupyter_kernel'];

    args.extend(['--slurm-parameter', slurm_parameter]);
    args.extend(['--loginnode', loginnode]);
    args.extend(['--proxyjump', proxyjump]);
    if srun_cmd is None:
        srun_cmd = 'srun';
    args.extend(['--srun-cmd', srun_cmd]);

    kernelcmd = kernelcmd.format(connection_file='{remote_connection_file}');
    args.extend(['--kernel-cmd', kernelcmd]);
    args.extend(['--connection-file', '{connection_file}']);

    if not re.search('slurm', str(displayname), re.IGNORECASE):
        displayname = "Slurm " + str(displayname);

    kerneldir_name = displayname.replace(' ', '_');
    username = getpass.getuser();

    if not environment is None:
        kernel_env = dict( (key.strip(), val.strip()) for key, val in (item.split('=') for item in environment.split(',')) ); 
        args.extend(['--environment', str(kernel_env)]);

    json_kernel = {
        'display_name': displayname,
        'env': kernel_env,
        'metadata': {"remote_slurm_kernel": True},
        'argv': args
    };
    if not language is None:
        json_kernel['language'] = language;

    # create a temporary jupyter kernel directory
    tempdir = tempfile.mkdtemp();

    kernel_loc = os.path.join(str(tempdir), 'kernel.json');
    with open(os.path.join(tempdir, 'kernel.json'), 'w') as kfile:
        json.dump(json_kernel, kfile, indent=2, sort_keys=True);

    img_dir = str(Path(slurm_jupyter_kernel.__file__).parent.parent) + '/imgs/';
    if os.path.isdir(str(img_dir)):
        copy(str(img_dir) + 'logo-32x32.png', str(tempdir));
        copy(str(img_dir) + 'logo-64x64.png', str(tempdir));

    kernel_path = kernelspec.install_kernel_spec(tempdir, kerneldir_name, user=username);

    print(f'\033[94m\u2714\033[0m \033[95m\033[0mSuccessfully created kernel: {kernel_path}\033[0m');

def modify_slurm_kernel (editor=None):

    available_slurm_kernel = list_slurm_kernel(returnonly=True);

    if len(available_slurm_kernel) >= 1:
        while True:
            print("\033[4mFollowing kernels found:\033[0m\n");
            iterator = 0;
            for kernelfile, data in available_slurm_kernel.items():
                print(f'\033[94m[{iterator}]\033[0m {kernelfile}');
                iterator += 1;
            identifier = input('Select a kernel using the identifier:\033[94m ');
            try:
                key = list(available_slurm_kernel.keys())[int(identifier)];
            except IndexError:
                print(f'\033[91mInvalid identifier: {identifier}\033[0m\n');
                continue;
            print('\033[0m');
            if key:
                kernelspec = key + '/kernel.json';
                if editor is None:
                    try:
                        editor = os.environ['EDITOR'];
                    except KeyError:
                        print(f'\033[91m$EDITOR not set. Please explicity set an editor with --editor (e.g. --editor vim)\033[0m\n');
                        sys.exit();
                else:
                    # TODO: Check explicity set editor (which editor)
                    pass;

                while True:
                    edit_process = subprocess.Popen(f'{editor} {kernelspec}', shell=True);
                    (stdout, stderr) = edit_process.communicate();
                    edit_process_status = edit_process.wait();
                    try:
                        # check modified kernel.json
                        with open(kernelspec, 'r') as f:
                            json.loads(f.read());

                    except json.decoder.JSONDecodeError:
                        print(f'\033[91mError parsing the modified kernel.json!\033[0m\n');
                        re_run = input('Would you like to re-run the edit mode? [Y,n] ');
                        if re_run == '' or re_run.upper() == 'Y':
                            continue;
                        elif re_run.upper() == 'N':
                            break;
                        else:
                            print(f'\033[91mInvalid input {re_run}! Aborting.\033[0m\n');
                            break;
                    
                    break;
                    
                # Modify done
                print(f'Successfully modified {kernelspec}!');
                sys.exit();
    

def list_slurm_kernel (all=False, verbose=False, returnonly=False):

    kernelspecs = kernelspec.find_kernel_specs();
    slurm_kernels = {};

    # iterate throuh all available kernels
    for kernel, file in kernelspecs.items():
        try:
            kernel_spec = kernelspec.get_kernel_spec(kernel);
        except json.decoder.JSONDecodeError:
            print(f'\033[91mError parsing {file}/kernel.json! Invalid JSON.\033[0m');
            continue;

        add = False;
        if all:
            add = True;
        else:
            try:
                is_slurm_kernel = kernel_spec.metadata['remote_slurm_kernel'] or None;
                if is_slurm_kernel == True:
                    add = True;
            except KeyError:
                # current slurm kernel is no jupyter slurm kernel
                pass;
        if add:
            slurm_kernels.update({str(file): [kernel_spec.name, kernel_spec.display_name, kernel_spec.language, kernel_spec.env]});

    

    if len(slurm_kernels) >= 1:
        # return only
        if returnonly:
            return slurm_kernels;

        print("\033[4mFollowing kernels found:\033[0m\n");
        for kernel, data in slurm_kernels.items():
            print(f'\033[94m\u27A4\033[0m \033[95m{kernel}\033[0m');
            if verbose:
                if data[0]:
                    print(f'  \u2937  \033[1mKernel Name  : \033[0m{data[0]}');
                else:
                    kernelname = kernel.split('/')[-1];
                    print(f'  \u2937  \033[1mKernel Name  : \033[0m{kernelname}') ;
                if data[2]: print(f'  \u2937  \033[1mLanguage     : \033[0m{data[2]}');
                if data[1]: print(f'  \u2937  \033[1mDisplay Name : \033[0m{data[1]}');
                if data[3]: print(f'  \u2937  \033[1mEnvironment  : \033[0m{data[3]}');
                print('');
    else:
        print('Currently no installed kernels found!');

def main (cmd_line=None):

    parser = argparse.ArgumentParser('Adding jupyter kernels using slurm');
    subparser = parser.add_subparsers(dest='command');

    add_option = subparser.add_parser('create', help='create a new slurm kernel');

    add_option.add_argument('--displayname', required=True, help='Display name of the new kernel');
    add_option.add_argument('--environment', required=False, help='Jupyter kernel environment');
    add_option.add_argument('--language', help='Programming language');
    add_option.add_argument('--loginnode', required=True, help='The login node to connect to');
    add_option.add_argument('--proxyjump', help='Add a proxy jump (SSH -J)');
    add_option.add_argument('--srun-cmd', help='Path to srun command. Default: srun');
    add_option.add_argument('--kernel-cmd', required=True, help='command to run jupyter kernel');
    add_option.add_argument('--slurm-parameter', required=True, help='Slurm job parameter');

    list_option = subparser.add_parser('list', help='list available slurm kernel');
    list_option.add_argument('-v', '--verbose', action='store_true', required=False, help='Print all kernel with the kernelspec information');
    list_option.add_argument('-a', '--all', action='store_true', required=False, help='Print all available Jupyter kernels');

    modify_option = subparser.add_parser('modify', help='modify an existing slurm kernel');
    modify_option.add_argument('-e', '--editor', help='Set a specific editor to modify the kernelspec (default: $EDITOR)');


    if len(sys.argv) == 1:
        parser.print_help();
        sys.exit();
    args = parser.parse_args(cmd_line);

    if args.command == 'create':
        add_slurm_kernel(args.displayname, args.language, args.kernel_cmd, args.slurm_parameter, args.loginnode, args.proxyjump, args.srun_cmd, args.environment);
    elif args.command == 'list':
        list_slurm_kernel(all=args.all, verbose=args.verbose);
    elif args.command == 'modify':
        modify_slurm_kernel(args.editor);

if __name__ == '__main__':
    main();

